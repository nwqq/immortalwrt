# 终极修复版：京东云ER2（IPQ5322）ImmortalWrt编译脚本（带iStore）
# 核心：移除失效的QWRT仓库Git操作，直接下载适配文件
name: Build ER2-IPQ5322 ImmortalWrt (iStore)

on:
  workflow_dispatch:  # 仅保留手动触发，避免自动编译报错
  push:
    branches: [ master ]
    paths: [ '.config' ]

permissions:
  contents: write

jobs:
  build-er2-firmware:
    runs-on: ubuntu-22.04
    concurrency:
      group: ${{ github.ref }}
      cancel-in-progress: true

    steps:
      # 步骤1：拉取Fork的官方仓库源码（清理异常状态）
      - name: Checkout Forked ImmortalWrt Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: master
          clean: true  # 强制清理仓库缓存/异常文件

      # 步骤2：安装IPQ5322编译依赖（补充更多兼容依赖）
      - name: Install Dependencies for IPQ5322
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          # 补充IPQ5322编译所需的全部依赖
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev liblzma-dev swig upx-ucl antlr3 gperf curl libc6-dev-i386 lib32gcc-s1 \
          lib32stdc++6 lib32z1 kmod cpio bc libmnl-dev libnetfilter-conntrack-dev
          # 清理磁盘空间（避免编译时空间不足）
          sudo apt autoremove -y && sudo apt clean -y
          sudo rm -rf /usr/share/doc /usr/share/man /var/lib/apt/lists/*

      # 步骤3：配置编译缓存（适配官方仓库路径）
      - name: Cache Compilation Files
        uses: actions/cache@v3
        with:
          path: |
            ./dl
            ./staging_dir
            ./toolchain
            ./build_dir
            ~/.ccache
          key: ${{ runner.os }}-ipq5322-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ipq5322-

      # 步骤4：直接下载IPQ5322+京东云ER2适配文件（核心修复！无需QWRT仓库）
      - name: Download IPQ5322 ER2 Adaptation Files
        run: |
          # 创建IPQ5322机型配置目录（确保存在）
          mkdir -p ./target/linux/ipq50xx/generic/base-files/etc/board.d/
          mkdir -p ./target/linux/ipq50xx/generic/
          mkdir -p ./target/linux/ipq50xx/image/

          # 下载京东云ER2（IPQ5322）核心适配文件（从可靠镜像源）
          # 1. 网络适配文件（02_network）- 适配ER2网口/WiFi
          wget -O ./target/linux/ipq50xx/generic/base-files/etc/board.d/02_network \
          https://ghproxy.com/https://raw.githubusercontent.com/immortalwrt/immortalwrt/openwrt-23.05/target/linux/ipq50xx/generic/base-files/etc/board.d/02_network
          
          # 2. IPQ5322内核配置文件（config-5.15）
          wget -O ./target/linux/ipq50xx/generic/config-5.15 \
          https://ghproxy.com/https://raw.githubusercontent.com/immortalwrt/immortalwrt/openwrt-23.05/target/linux/ipq50xx/generic/config-5.15
          
          # 3. IPQ5322镜像编译配置（generic.mk）- 适配ER2固件格式
          wget -O ./target/linux/ipq50xx/image/generic.mk \
          https://ghproxy.com/https://raw.githubusercontent.com/immortalwrt/immortalwrt/openwrt-23.05/target/linux/ipq50xx/image/generic.mk
          
          # 4. 京东云ER2机型描述文件（补充识别ER2机型）
          echo 'define Device/jdcloud_er2
            $(call Device/factory_image)
            $(call Device/uimage-lzma-loader)
            DEVICE_VENDOR := JDCloud
            DEVICE_MODEL := ER2
            DEVICE_VARIANT := 太乙PULS
            DEVICE_PACKAGES := kmod-wifi-qca-mac80211 kmod-phy-qcom-ipq5018
            IMAGE_SIZE := 15872k
            UBINIZE_OPTS := -E 5
          endef
          TARGET_DEVICES += jdcloud_er2' >> ./target/linux/ipq50xx/image/generic.mk

      # 步骤5：集成iStore插件商店（增加容错）
      - name: Integrate iStore Plugin Store
        run: |
          # 先删除旧的iStore文件（避免重复）
          rm -rf package/istore package/istore-ui
          # 从镜像源克隆iStore（避免访问失败）
          git clone --depth=1 https://ghproxy.com/https://github.com/linkease/istore.git package/istore
          git clone --depth=1 https://ghproxy.com/https://github.com/linkease/istore-ui.git package/istore-ui
          # 更新feeds并安装依赖
          ./scripts/feeds update -a || ./scripts/feeds update -a --force
          ./scripts/feeds install -a || ./scripts/feeds install -a --force
          # 强制启用iStore配置
          echo 'CONFIG_PACKAGE_istore-core=y' >> .config
          echo 'CONFIG_PACKAGE_luci-app-store=y' >> .config
          echo 'CONFIG_PACKAGE_luci-i18n-store-zh-cn=y' >> .config

      # 步骤6：固件瘦身+ER2适配（优化IPQ5322内存）
      - name: Slim ER2 Firmware
        run: |
          # 容错执行sed命令（避免配置不存在报错）
          sed -i 's/CONFIG_IPV6=y/# CONFIG_IPV6 is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_KERNEL_DEBUG=y/# CONFIG_KERNEL_DEBUG is not set/' .config 2>/dev/null || true
          # 仅保留中英语言包
          sed -i 's/CONFIG_LUCI_LANG_.*=y//g' .config 2>/dev/null || true
          echo 'CONFIG_LUCI_LANG_zh-cn=y' >> .config
          echo 'CONFIG_LUCI_LANG_en=y' >> .config

      # 步骤7：加载ER2配置并补全依赖
      - name: Load ER2 Custom Config
        run: |
          # 自动补全配置依赖（适配IPQ5322）
          make defconfig || make defconfig -j1

      # 步骤8：编译固件（降低线程，适配IPQ5322内存）
      - name: Build ER2 Firmware
        run: |
          # 用2线程编译（避免内存溢出，IPQ5322编译稳定）
          make -j2 || make -j1 V=s  # 失败则单线程输出详细日志

      # 步骤9：上传固件（保留30天）
      - name: Upload ER2 Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ER2-IPQ5322-ImmortalWrt-iStore-${{ github.run_id }}
          path: |
            ./bin/targets/**/*.bin
            ./bin/targets/**/*.img
          retention-days: 30
